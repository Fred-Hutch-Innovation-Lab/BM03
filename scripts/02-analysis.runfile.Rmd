---
title: 'TCR QC'
author: "FHIL\nDerrikGratz"
date: '`r Sys.Date()`'
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      fig.width = 8, fig.height = 6,
                      cache=FALSE, cache.lazy = FALSE, dev='svg') 

library(tidyverse)  ## General R logic
library(here)       ## Easier specification of file locations
library(immunarch)  ## MixCR output parsing and stats
library(khroma)     ## colorblind friendly palettes
library(ggbeeswarm) ## swarm plots
library(ggh4x)      ## Nested facet plots
library(plotly)     ## interactive heatmaps
library(magrittr)   ## fun pipes
library(stringr)    ## Str_match
library(data.table) ## rbindlist

set.seed(44)
```

```{r}
dataset <- 'downsampled_by_read'# 'full' 'downsampled_by_umi' 
```

```{r}
figures <- list()
```

# Functions

```{r}
parse_name <- function(x) {
  x <- as.data.frame(str_match(x, '(^.)-(F\\d)(L|S)(A|B)?_*(.+)?'))
  colnames(x) <- c(
    'sample', 'kit', 'individual', 'size', 'replicate', 'chain'
  )
  x %>%
    mutate(
      replicate = if_else(is.na(replicate), 'A', replicate),
      kit = case_when(
        kit == 'N' ~ 'NEB',
        kit == 'Q' ~ 'QiaSeq',
        kit == 'T' ~ 'Takara',
        kit == 'C' ~ 'Cellecta',
        .default = 'unknown'
      )
    )
}
```

```{r, eval=FALSE}
my_repLoad <- function(filepath) {
  x <- read.csv(filepath, header=TRUE, sep='\t') %>%
    select(cloneId, uniqueMoleculeCount, uniqueMoleculeFraction) %>%
    rename('Clones'=uniqueMoleculeCount,
           'Proportion'=uniqueMoleculeFraction)
  y <- suppressMessages(repLoad(filepath))[['data']]
  chainname <- names(y)
  message(chainname)
  y[[chainname]] <- y[[chainname]] %>%
    rename('Read.count'=Clones,
           'Read.proportion'=Proportion)
  y[[chainname]] <- merge(x,y[[chainname]], by.x='cloneId', by.y='Clone.ID') %>%
    as_tibble()
  y
    # rename("Clones"=uniqueMoleculeCount,
    #        "Proportion"=uniqueMoleculeFraction,
    #        "CDR3.nt"=nSeqCDR3,
    #        "CDR3.aa"=aaSeqCDR3,
    #        "V.name"=allVHitsWithScore,
    #        "D.name"=allDHitsWithScore,
    #        "J.name"=allJHitsWithScore,
    #        "V.end"=,
    #        "D.start"=,
    #        "D.end"=,
    #        "J.start"=,
    #        "VJ.ins"=,
    #        "VD.ins"=,
    #        "DJ.ins"=,
    #        "Sequence")
}

tmp <- lapply(dir(here('../processing/mixcr/qiaseq/Q-F1LA/'), pattern = '*_[TI].+.tsv', full.names = TRUE), 
              my_repLoad)
```

# Generate RDS

```{r downsampled_data_UMI, eval=FALSE}
data_dir <- here('../processing/mixcr/downsampled_data/by_umi/')
rep_data_downsampled <- repLoad(data_dir)

#parse metadata from samplenames, based on previous function
metadata <- as_tibble(rbindlist(lapply(names(rep_data_downsampled$data), parse_name)))
metadata <- metadata %>%
  mutate(Sample = sample,
         sample = NULL)
metadata$chain[is.na(metadata$chain)] <- 'other'
metadata$chain <- factor(metadata$chain, 
                         levels = c(
                           'TRA', 'TRB',
                           'TRD', 'TRG',
                           'ILH', 'IGK', 'IGH', 'IGL',
                           'other'
                         ))
rep_data_downsampled$meta <- metadata

## Fix clone count to be UMIs rather than reads
## still retains read counts too, but sets Clones and Proportion to be UMI based
for (sample in names(rep_data_downsampled$data)) {
  x <- file.path(here('../processing/mixcr/downsampled_data/by_umi/'), 
                 gsub('(.-F[0-9][^_]+).+','\\1', sample),
                 paste0(sample, '.tsv'))
            
  #        pattern=paste0(sample, '.tsv'),
  #        recursive = TRUE, full.names = TRUE) %>%
  x <- read.csv(x, header=TRUE, sep='\t') %>%
    select(cloneId, uniqueMoleculeCount, uniqueMoleculeFraction) %>%
    rename('Clones'=uniqueMoleculeCount,
           'Proportion'=uniqueMoleculeFraction)
  y <- rep_data_downsampled$data[[sample]]
  y <- y %>%
    rename('Read.count'=Clones,
           'Read.proportion'=Proportion)
  rep_data_downsampled$data[[sample]] <- merge(x,y, by.x='cloneId', by.y='Clone.ID') %>%
    as_tibble()
}

saveRDS(rep_data_downsampled, here('rds/rep_data_downsampled_umi.rds'))
```

```{r downsampled_data_reads, eval=FALSE}
data_dir <- here('../processing/mixcr/downsampled_data/by_reads/')
rep_data_downsampled <- repLoad(data_dir)

#parse metadata from samplenames, based on previous function
metadata <- as_tibble(rbindlist(lapply(names(rep_data_downsampled$data), parse_name)))
metadata <- metadata %>%
  mutate(Sample = sample,
         sample = NULL)
metadata$chain[is.na(metadata$chain)] <- 'other'
metadata$chain <- factor(metadata$chain, 
                         levels = c(
                           'TRA', 'TRB',
                           'TRD', 'TRG',
                           'ILH', 'IGK', 'IGH', 'IGL',
                           'other'
                         ))
rep_data_downsampled$meta <- metadata

## Fix clone count to be UMIs rather than reads
## still retains read counts too, but sets Clones and Proportion to be UMI based
for (sample in names(rep_data_downsampled$data)) {
  x <- file.path(here('../processing/mixcr/downsampled_data/by_reads/'), 
                 gsub('(.-F[0-9][^_]+).+','\\1', sample),
                 paste0(sample, '.tsv'))
            
  #        pattern=paste0(sample, '.tsv'),
  #        recursive = TRUE, full.names = TRUE) %>%
  x <- read.csv(x, header=TRUE, sep='\t') %>%
    select(cloneId, uniqueMoleculeCount, uniqueMoleculeFraction) %>%
    rename('Clones'=uniqueMoleculeCount,
           'Proportion'=uniqueMoleculeFraction)
  y <- rep_data_downsampled$data[[sample]]
  y <- y %>%
    rename('Read.count'=Clones,
           'Read.proportion'=Proportion)
  rep_data_downsampled$data[[sample]] <- merge(x,y, by.x='cloneId', by.y='Clone.ID') %>%
    as_tibble()
}

saveRDS(rep_data_downsampled, here('rds/rep_data_downsampled_reads.rds'))
```

```{r full_data, eval=FALSE, message=FALSE}
data_dir <- here('../processing/mixcr/full_data/')
rep_data <- repLoad(data_dir)

#parse metadata from samplenames, based on previous function
metadata <- as_tibble(rbindlist(lapply(names(rep_data$data), parse_name)))
metadata <- metadata %>%
  mutate(Sample = sample,
         sample = NULL)
metadata$chain[is.na(metadata$chain)] <- 'other'
metadata$chain <- factor(metadata$chain, 
                         levels = c(
                           'TRA', 'TRB',
                           'TRD', 'TRG',
                           'ILH', 'IGK', 'IGH', 'IGL',
                           'other'
                         ))
rep_data$meta <- metadata

## Fix clone count to be UMIs rather than reads
## still retains read counts too, but sets Clones and Proportion to be UMI based
for (sample in names(rep_data$data)) {
  kit <- filter(rep_data$meta, Sample == sample)
  kit <- tolower(kit$kit)
  x <- file.path(here('../processing/mixcr/full_data/'),
                 kit,
                 gsub('(.-F[0-9][^_]+).+','\\1', sample),
                 paste0(sample, '.tsv'))
            
  #        pattern=paste0(sample, '.tsv'),
  #        recursive = TRUE, full.names = TRUE) %>%
  x <- read.csv(x, header=TRUE, sep='\t') %>%
    select(cloneId, uniqueMoleculeCount, uniqueMoleculeFraction) %>%
    rename('Clones'=uniqueMoleculeCount,
           'Proportion'=uniqueMoleculeFraction)
  y <- rep_data$data[[sample]]
  y <- y %>%
    rename('Read.count'=Clones,
           'Read.proportion'=Proportion)
  rep_data$data[[sample]] <- merge(x,y, by.x='cloneId', by.y='Clone.ID') %>%
    as_tibble()
}
saveRDS(rep_data, here('rds/rep_data_full.rds'))
```

# Load TCR data

```{r}
if (dataset == 'downsampled_by_read') {
  rep_data <- readRDS(here('rds/rep_data_downsampled_reads.rds'))
} else if (dataset == 'downsampled_by_umi') {
  rep_data <- readRDS(here('rds/rep_data_downsampled_umi.rds'))
} else if (dataset == 'full') {
  rep_data <- readRDS(here('rds/rep_data_full.rds'))
}
```

```{r Bootstrap_downsampling_test, eval=FALSE}
tmp <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 kit = include('QiaSeq'),
                 size = include('L'))) 

k <- 100
bootstrap_counts <- as.data.frame(matrix(nrow=6, ncol=k), row.names = names(tmp$data))
bootstrap_diversity <- as.data.frame(matrix(nrow=6, ncol=k), row.names = names(tmp$data))
for (j in 1:k) {
  tmp1 <- repSample(tmp$data, .method='downsample', .n=150000)
  bootstrap_diversity[,j] <- repDiversity(.data=tmp1, .method = 'inv.simp')$Value
  bootstrap_counts[,j] <- repExplore(.data = tmp1, .method = c("volume"))$Volume
}

bootstrap_counts %>%
  rownames_to_column('Sample') %>%
  melt() %>%
ggplot(aes(x=Sample, y=value)) +
  geom_boxplot()

```

# Clone count

## Large

### TRATRB

```{r}
figures[['chain_recovery_large_TRATRB']] <- 
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('L'))) %>%
  repExplore(.data = .[['data']], .method = c("clones")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Clones)) +
  geom_boxplot() +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=2) +
  labs(x='Kit', y='Total recovery')
figures[['chain_recovery_large_TRATRB']]
```

### Other

```{r}
figures[['chain_recovery_large_other']] <- 
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = exclude('TRA', 'TRB'),
                 size = include('L'))) %>%
  repExplore(.data = .[['data']], .method = c("clones")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Clones)) +
  geom_boxplot() +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  facet_wrap(~chain, strip.position = 'top', ncol=3, scales = 'free_y') +
  labs(x='Kit', y='Total recovery')
figures[['chain_recovery_large_other']]
```

## Small

### TRATRB

```{r}
figures[['chain_recovery_small_TRATRB']] <- 
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('S'))) %>%
  repExplore(.data = .[['data']], .method = c("clones")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Clones)) +
  geom_boxplot() +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=2) +
  labs(x='Kit', y='Total recovery')
figures[['chain_recovery_small_TRATRB']]
```

### Other

```{r}
figures[['chain_recovery_other_small']] <- 
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = exclude('TRA', 'TRB'),
                 size = include('S'))) %>%
  repExplore(.data = .[['data']], .method = c("clones")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Clones)) +
  geom_boxplot() +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  facet_wrap(~chain, strip.position = 'top', ncol=3, scales = 'free') +
  labs(x='Kit', y='Total recovery')
figures[['chain_recovery_other_small']]
```

<!-- # Chain recovery -->

<!-- ## Large -->

<!-- ### TRATRB -->

<!-- ```{r} -->
<!-- figures[['chain_recovery_large_TRATRB']] <-  -->
<!--   repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(chain = include('TRA', 'TRB'), -->
<!--                  size = include('L'))) %>% -->
<!--   repExplore(.data = .[['data']], .method = c("count")) %>% -->
<!--   group_by(Sample) %>% -->
<!--   summarize(n=sum(Clonotypes)) %>% -->
<!--   left_join(rep_data$meta, by = 'Sample') %>% -->
<!--   ggplot(aes(x=kit, y=n)) + -->
<!--   geom_boxplot(outlier.shape = NULL) + -->
<!--   geom_beeswarm(aes(shape=individual), size=2) + -->
<!--   theme_bw() + -->
<!--   theme(panel.spacing = unit(0, "lines")) + -->
<!--   facet_wrap(~chain, strip.position = 'top', ncol=2) + -->
<!--   labs(x='Chain', y='Total recovery') -->
<!-- figures[['chain_recovery_large_TRATRB']] -->
<!-- ``` -->

<!-- ### Other -->

<!-- ```{r} -->
<!-- figures[['chain_recovery_large_other']] <-  -->
<!--   repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(chain = exclude('TRA', 'TRB'), -->
<!--                  size = include('L'))) %>% -->
<!--   repExplore(.data = .[['data']], .method = c("count")) %>% -->
<!--   group_by(Sample) %>% -->
<!--   summarize(n=sum(Clonotypes)) %>% -->
<!--   left_join(rep_data$meta, by = 'Sample') %>% -->
<!--   ggplot(aes(x=kit, y=n)) + -->
<!--   geom_boxplot(outlier.shape = NULL) + -->
<!--   geom_beeswarm(aes(shape=individual), size=2) + -->
<!--   theme_bw() + -->
<!--   theme(panel.spacing = unit(0, "lines")) + -->
<!--   facet_wrap(~chain, strip.position = 'top', ncol=3) + -->
<!--   labs(x='Chain', y='Total recovery') -->
<!-- figures[['chain_recovery_large_other']] -->
<!-- ``` -->

<!-- ## Small -->

<!-- ### TRATRB -->

<!-- ```{r} -->
<!-- figures[['chain_recovery_small_TRATRB']] <-  -->
<!--   repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(chain = include('TRA', 'TRB'), -->
<!--                  size = include('S'))) %>% -->
<!--   repExplore(.data = .[['data']], .method = c("volume")) %>% -->
<!--   left_join(rep_data$meta, by = 'Sample') %>% -->
<!--   ggplot(aes(x=kit, y=Volume)) + -->
<!--   geom_boxplot(outlier.shape = NULL) + -->
<!--   geom_beeswarm(aes(shape=individual), size=2) + -->
<!--   theme_bw() + -->
<!--   theme(panel.spacing = unit(0, "lines")) + -->
<!--   facet_wrap(~chain, strip.position = 'top', ncol=2) + -->
<!--   labs(x='Chain', y='Total recovery') -->
<!-- figures[['chain_recovery_small_TRATRB']] -->
<!-- ``` -->

<!-- ### Other -->

<!-- ```{r} -->
<!-- figures[['chain_recovery_small_other']] <-  -->
<!--   repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(chain = exclude('TRA', 'TRB'), -->
<!--                  size = include('S'))) %>% -->
<!--   repExplore(.data = .[['data']], .method = c("volume")) %>% -->
<!--   left_join(rep_data$meta, by = 'Sample') %>% -->
<!--   ggplot(aes(x=kit, y=Volume)) + -->
<!--   geom_boxplot(outlier.shape = NULL) + -->
<!--   geom_beeswarm(aes(shape=individual), size=2) + -->
<!--   theme_bw() + -->
<!--   theme(panel.spacing = unit(0, "lines")) + -->
<!--   facet_wrap(~chain, strip.position = 'top', ncol=3) + -->
<!--   labs(x='Chain', y='Total recovery') -->
<!-- figures[['chain_recovery_small_other']] -->
<!-- ``` -->

# Unique clone count

## Large

### TRATRB

```{r}
figures[['unique_clones_large_TRATRB']] <- 
   repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('L'))) %>%
  repExplore(.data = .[['data']], .method = c("volume")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Volume)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=2) +
  labs(x='Chain', y='Unique clones')
figures[['unique_clones_large_TRATRB']]
```

### other

```{r}
figures[['unique_clones_large_other']] <- 
   repFilter(rep_data,
            .method = 'by.meta',
            list(chain = exclude('TRA', 'TRB'),
                 size = include('L'))) %>%
  repExplore(.data = .[['data']], .method = c("volume")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Volume)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=3) +
  labs(x='Chain', y='Unique clones')
figures[['unique_clones_large_other']]
```

## Small

### TRATRB

```{r}
figures[['unique_clones_small_TRATRB']] <- 
   repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('S'))) %>%
  repExplore(.data = .[['data']], .method = c("volume")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Volume)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=2) +
  labs(x='Chain', y='Unique clones')
figures[['unique_clones_small_TRATRB']]
```

### other

```{r}
figures[['unique_clones_small_other']] <- 
   repFilter(rep_data,
            .method = 'by.meta',
            list(chain = exclude('TRA', 'TRB'),
                 size = include('S'))) %>%
  repExplore(.data = .[['data']], .method = c("volume")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Volume)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=3, scales='free') +
  labs(x='Chain', y='Unique clones')
figures[['unique_clones_small_other']]
```

# Clone count proportions

## Large

### TRATRB

```{r}
figures[['clone_count_proportion_large_TRATRB']] <-
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('L'))) %>%
  repClonality(.data = .[['data']], .method='rare') %>%
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  reshape2::melt(id.col='Sample') %>%
  group_by(Sample) %>%
  mutate(x = value-lag(value, default = 0)) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=paste0(individual, replicate), y=x, fill=variable)) +
  geom_col(position='stack') +
  # theme_bw() +
  theme(axis.text.x = element_text(angle=90)) +
  scale_fill_manual(values=color('muted')(6), labels=c('1','2-3','4-10','11-30','31-100', '101-MAX')) +
  labs(x='sample', y='Portion of repertoire', fill='UMI counts') +
  facet_nested(~kit + chain, scales = 'free_x') 
figures[['clone_count_proportion_large_TRATRB']]
```

## Small

### TRATRB

```{r}
tmp <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('L'))) 
tmp <- lapply(tmp$data, function(x) x$Proportion) %>%
  melt() %>%
  mutate(Sample=L1) %>%
    left_join(rep_data$meta,  by='Sample') 
tmp %>%
  mutate(bin = cut(value, breaks = c(0,1e-5,1e-4,1e-3,1e-2,1e-1,1), right=FALSE)) %>%
  group_by(Sample, bin) %>%
  summarize(count=n())
```


```{r}
figures[['clone_count_proportion_small_TRATRB']] <-
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('S'))) %>%
  repClonality(.data = .[['data']], .method='rare') %>%
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  reshape2::melt(id.col='Sample') %>%
  group_by(Sample) %>%
  mutate(x = value-lag(value, default = 0)) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=paste0(individual, replicate), y=x, fill=variable)) +
  geom_col(position='stack') +
  # theme_bw() +
  theme(axis.text.x = element_text(angle=90)) +
  scale_fill_manual(values=color('muted')(6), labels=c('1','2-3','4-10','11-30','31-100', '101-MAX')) +
  labs(x='sample', y='Portion of repertoire', fill='UMI counts') +
  facet_nested(~kit + chain, scales = 'free_x') 
figures[['clone_count_proportion_small_TRATRB']]
```

# Clone frequency proportion

## Large

```{r}
figures[['clone_frequency_proportion_large_TRATRB']] <-
  repFilter(rep_data,
              .method = 'by.meta',
              list(chain = include('TRA', 'TRB'),
                   size = include('L'))) %>%
  repClonality(.data = .[['data']], .method='homeo',
               .clone.types = c(Rare = 1e-05, Small = 1e-04, Medium = 0.001, Large = 0.01,
    Hyperexpanded = 1),) %>%
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  reshape2::melt(id.col='Sample') %>%
  group_by(Sample) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=paste0(individual, replicate), y=value, fill=variable)) +
  geom_col(position='stack') +
  # theme_bw() +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x='Sample', y='Portion of repertoire', fill='Clonotype group', title = 'Clonal space homeostasis', caption= 'Summary of proportion of clonotypes with specific frequencies') +
  facet_nested(~kit + chain, scales = 'free_x') 
figures[['clone_frequency_proportion_large_TRATRB']]
```

## Small

```{r}
figures[['clone_frequency_proportion_small_TRATRB']] <-
  repFilter(rep_data,
              .method = 'by.meta',
              list(chain = include('TRA', 'TRB'),
                   size = include('S'))) %>%
  repClonality(.data = .[['data']], .method='homeo') %>%
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  reshape2::melt(id.col='Sample') %>%
  group_by(Sample) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=paste0(individual, replicate), y=value, fill=variable)) +
  geom_col(position='stack') +
  # theme_bw() +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x='Sample', y='Portion of repertoire', fill='Clonotype group', title = 'Clonal space homeostasis', caption= 'Summary of proportion of clonotypes with specific frequencies') +
  facet_nested(~kit + chain, scales = 'free_x') 
figures[['clone_frequency_proportion_small_TRATRB']]
```

# Gene usage

## TRBV

### Large

```{r, fig.width=10, fig.height=10}
figures[['trbv_usage_cor_large']] <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'),
                 size = include('L'))) %>%
  geneUsage(.data=.[['data']], .gene='hs.trbv', .norm = T) %>% 
  geneUsageAnalysis(.method='cor')  %>%
  melt() %>%
  mutate(Var1 = gsub('(.+)__TRB', '\\1', Var1),
         Var2 = gsub('(.+)__TRB', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,12.5, 18.5), color='red') + 
  geom_hline(yintercept = c(6.5,12.5, 18.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Correlation') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))

figures[['trbv_usage_cor_large']] %<>% ggplotly()
figures[['trbv_usage_cor_large']]
```

### Small

```{r, fig.width=10, fig.height=10}
figures[['trbv_usage_cor_small']] <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'),
                 size = include('S'))) %>%
  geneUsage(.data=.[['data']], .gene='hs.trbv', .norm = T) %>% 
  geneUsageAnalysis(.method='cor')  %>%
  melt() %>%
  mutate(Var1 = gsub('(.+)__TRB', '\\1', Var1),
         Var2 = gsub('(.+)__TRB', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,10.5, 16.5), color='red') + 
  geom_hline(yintercept = c(6.5,10.5, 16.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Correlation') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))

figures[['trbv_usage_cor_small']] %<>% ggplotly()
figures[['trbv_usage_cor_small']]
```

## TRBJ

### Large

```{r, fig.width=10, fig.height=10}
figures[['trbj_usage_cor_large']] <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'),
                 size = include('L'))) %>%
  geneUsage(.data=.[['data']], .gene='hs.trbj', .norm = T) %>% 
  geneUsageAnalysis(.method='cor')  %>%
  melt() %>%
  mutate(Var1 = gsub('(.+)__TRB', '\\1', Var1),
         Var2 = gsub('(.+)__TRB', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,12.5, 18.5), color='red') + 
  geom_hline(yintercept = c(6.5,12.5, 18.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Correlation') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))

figures[['trbj_usage_cor_large']] %<>% ggplotly()
figures[['trbj_usage_cor_large']]
```

### Small

```{r, fig.width=10, fig.height=10}
figures[['trbj_usage_cor_small']] <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'),
                 size = include('S'))) %>%
  geneUsage(.data=.[['data']], .gene='hs.trbj', .norm = T) %>% 
  geneUsageAnalysis(.method='cor')  %>%
  melt() %>%
  mutate(Var1 = gsub('(.+)__TRB', '\\1', Var1),
         Var2 = gsub('(.+)__TRB', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,10.5, 16.5), color='red') + 
  geom_hline(yintercept = c(6.5,10.5, 16.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Correlation') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))

figures[['trbj_usage_cor_small']] %<>% ggplotly()
figures[['trbj_usage_cor_small']]
```

## TRAV

### Large

```{r, fig.width=10, fig.height=10}
figures[['trav_usage_cor_large']] <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 size = include('L'))) %>%
  geneUsage(.data=.[['data']], .gene='hs.trav', .norm = T) %>% 
  geneUsageAnalysis(.method='cor')  %>%
  melt() %>%
  mutate(Var1 = gsub('(.+)__TRA', '\\1', Var1),
         Var2 = gsub('(.+)__TRA', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,12.5, 18.5), color='red') + 
  geom_hline(yintercept = c(6.5,12.5, 18.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Correlation') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))

figures[['trav_usage_cor_large']] %<>% ggplotly()
figures[['trav_usage_cor_large']]
```

### Small

```{r, fig.width=10, fig.height=10}
figures[['trav_usage_cor_small']] <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 size = include('S'))) %>%
  geneUsage(.data=.[['data']], .gene='hs.trav', .norm = T) %>% 
  geneUsageAnalysis(.method='cor')  %>%
  melt() %>%
  mutate(Var1 = gsub('(.+)__TRA', '\\1', Var1),
         Var2 = gsub('(.+)__TRA', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,10.5, 16.5), color='red') + 
  geom_hline(yintercept = c(6.5,10.5, 16.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Correlation') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))

figures[['trav_usage_cor_small']] %<>% ggplotly()
figures[['trav_usage_cor_small']]
```

## TRAJ

### Large

```{r, fig.width=10, fig.height=10}
figures[['traj_usage_cor_large']] <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 size = include('L'))) %>%
  geneUsage(.data=.[['data']], .gene='hs.traj', .norm = T) %>% 
  geneUsageAnalysis(.method='cor')  %>%
  melt() %>%
  mutate(Var1 = gsub('(.+)__TRA', '\\1', Var1),
         Var2 = gsub('(.+)__TRA', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,12.5, 18.5), color='red') + 
  geom_hline(yintercept = c(6.5,12.5, 18.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Correlation') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))

figures[['traj_usage_cor_large']] %<>% ggplotly()
figures[['traj_usage_cor_large']]
```

### Small

```{r, fig.width=10, fig.height=10}
figures[['traj_usage_cor_small']] <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 size = include('S'))) %>%
  geneUsage(.data=.[['data']], .gene='hs.trav', .norm = T) %>% 
  geneUsageAnalysis(.method='cor')  %>%
  melt() %>%
  mutate(Var1 = gsub('(.+)__TRA', '\\1', Var1),
         Var2 = gsub('(.+)__TRA', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,10.5, 16.5), color='red') + 
  geom_hline(yintercept = c(6.5,10.5, 16.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Correlation') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))

figures[['traj_usage_cor_small']] %<>% ggplotly()
figures[['traj_usage_cor_small']]
```

# Diversity estimation

## Large

```{r}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('L'))) 
plotdata <- repDiversity(.data=plotdata$data, .method = 'inv.simp') %>%
  left_join(rep_data$meta, by = 'Sample')
figures[['simpson_large']] <-
  ggplot(plotdata, aes(x=kit, y=Value)) +
    geom_boxplot(outliers = FALSE) +
    geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=2) +
  scale_y_log10() +
  labs(x='Chain', y='Simpson index', caption='Y axis is log scaled')
  
figures[['simpson_large']]
```

## Small

```{r}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('S'))) 
figures[['simpson_small']] <-
  repDiversity(.data=plotdata$data, .method = 'inv.simp') %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Value)) +
    geom_boxplot(outliers = FALSE) +
    geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  scale_y_log10() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=2) +
  labs(x='Chain', y='Simpson index', caption='Y axis is log scaled')
  
figures[['simpson_small']]
```

# Jaccard similarity

## By individual

```{r, fig.width=8, fig.height=7}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'jaccard') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt() %>%
  mutate(Var1 = gsub('(.+)__TRA', '\\1', Var1),
         Var2 = gsub('(.+)__TRA', '\\1', Var2)) %>%
  filter(grepl('2', Var1) & grepl('2', Var2))
  # geom_vline(xintercept = c(4.5, 8.5, 12.5)) +
  # geom_hline(yintercept = c(4.5, 8.5, 12.5))

figures[['jaccard_F2_tra']]  <- 
(ggplot(plotdata, aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(4.5, 8.5, 12.5), color='black') + 
  geom_hline(yintercept = c(4.5,8.5, 12.5), color='black') + 
  theme_bw() +
  scale_fill_viridis_c(option='plasma') +
  theme(axis.text.x = element_text(angle=90)) +
   scale_fill_viridis_c(option='plasma') +
  labs(x=NULL, y=NULL, fill = 'Jaccard index')) #%>%
  # ggplotly()
figures[['jaccard_F2_tra']] 



  # xlim(levels(plotdata$rn)) + ylim(levels(plotdata$variable)) +
  # scale_fill_viridis_c(option='plasma') +
  # theme(axis.text.x = element_text(angle=90)) +
  # geom_vline(xintercept = c(4.5, 8.5, 12.5)) +
  # geom_hline(yintercept = c(4.5, 8.5, 12.5)) 

```

## All

### TRA

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'jaccard') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['jaccard_all_tra']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)__TRA', '\\1', Var1),
         Var2 = gsub('(.+)__TRA', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(12.5,22.5, 34.5), color='red') + 
  geom_hline(yintercept = c(12.5,22.5, 34.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Jaccard index') +
  scale_fill_viridis_c(option='plasma') +
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['jaccard_all_tra']] 
```

### TRB

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'jaccard') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['jaccard_all_trb']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)__TRB', '\\1', Var1),
         Var2 = gsub('(.+)__TRB', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(12.5,22.5, 34.5), color='red') + 
  geom_hline(yintercept = c(12.5,22.5, 34.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Jaccard index') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['jaccard_all_trb']] 
```

## Small

### TRA

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 size = include('S'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'jaccard') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['jaccard_small_tra']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)__TRA', '\\1', Var1),
         Var2 = gsub('(.+)__TRA', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,10.5, 16.5), color='red') + 
  geom_hline(yintercept = c(6.5,10.5, 16.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Jaccard index') +
  scale_fill_viridis_c(option='plasma') +
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['jaccard_small_tra']] 
```

### TRB

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'),
                 size = include('S'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'jaccard') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['jaccard_small_trb']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)__TRB', '\\1', Var1),
         Var2 = gsub('(.+)__TRB', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,10.5, 16.5), color='red') + 
  geom_hline(yintercept = c(6.5,10.5, 16.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Jaccard index') +
  scale_fill_viridis_c(option='plasma') +
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['jaccard_small_trb']] 
```

## Large

### TRA

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 size = include('L'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'jaccard') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['jaccard_large_tra']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)__TRA', '\\1', Var1),
         Var2 = gsub('(.+)__TRA', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,12.5, 18.5), color='red') + 
  geom_hline(yintercept = c(6.5,12.5, 18.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Jaccard index') +
  scale_fill_viridis_c(option='plasma') +
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['jaccard_large_tra']] 
```

### TRB

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'),
                 size = include('L'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'jaccard') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['jaccard_large_trb']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)__TRB', '\\1', Var1),
         Var2 = gsub('(.+)__TRB', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,12.5, 18.5), color='red') + 
  geom_hline(yintercept = c(6.5,12.5, 18.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Jaccard index') +
  scale_fill_viridis_c(option='plasma') +
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['jaccard_large_trb']] 
```

## MDS

### Small

#### TRB

```{r}
imm_ov1 <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'),
                 size = include('S'))) 
imm_ov1 <- repOverlap(.data = imm_ov1$data, .method = "jaccard", .verbose = F)
imm_ov1 <- repOverlapAnalysis(imm_ov1, "mds") 
figures[['jaccard_mds_small_TRB']] <-
  as.data.frame(imm_ov1$points) %>%
  rownames_to_column('Sample') %>%
  left_join(rep_data$meta, by='Sample') %>%
  mutate(V1=scale(V1), V2=scale(V2)) %>%
  ggplot(aes(x=V1, y=V2, color=kit, shape=individual)) +
  geom_point() +
  lims(x=c(-3,3), y=c(-3,3))
figures[['jaccard_mds_small_TRB']]
```

#### TRA

```{r}
imm_ov1 <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 size = include('S'))) 
imm_ov1 <- repOverlap(.data = imm_ov1$data, .method = "jaccard", .verbose = F)
imm_ov1 <- repOverlapAnalysis(imm_ov1, "mds") 
figures[['jaccard_mds_small_TRA']] <-
  as.data.frame(imm_ov1$points) %>%
  rownames_to_column('Sample') %>%
  left_join(rep_data$meta, by='Sample') %>%
  mutate(V1=scale(V1), V2=scale(V2)) %>%
  ggplot(aes(x=V1, y=V2, color=kit, shape=individual)) +
  geom_point() +
  lims(x=c(-3,3), y=c(-3,3))
figures[['jaccard_mds_small_TRA']]
```

### Large

#### TRB

```{r}
imm_ov1 <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'),
                 size = include('L'))) 
imm_ov1 <- repOverlap(.data = imm_ov1$data, .method = "jaccard", .verbose = F)
imm_ov1 <- repOverlapAnalysis(imm_ov1, "mds") 
figures[['jaccard_mds_large_TRB']] <-
  as.data.frame(imm_ov1$points) %>%
  rownames_to_column('Sample') %>%
  left_join(rep_data$meta, by='Sample') %>%
  mutate(V1=scale(V1), V2=scale(V2)) %>%
  ggplot(aes(x=V1, y=V2, color=kit, shape=individual)) +
  geom_point() +
  lims(x=c(-3,3), y=c(-3,3))
figures[['jaccard_mds_large_TRB']]
```

#### TRA

```{r}
imm_ov1 <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 size = include('L'))) 
imm_ov1 <- repOverlap(.data = imm_ov1$data, .method = "jaccard", .verbose = F)
imm_ov1 <- repOverlapAnalysis(imm_ov1, "mds") 
figures[['jaccard_mds_large_TRA']] <-
  as.data.frame(imm_ov1$points) %>%
  rownames_to_column('Sample') %>%
  left_join(rep_data$meta, by='Sample') %>%
  mutate(V1=scale(V1), V2=scale(V2)) %>%
  ggplot(aes(x=V1, y=V2, color=kit, shape=individual)) +
  geom_point() +
  lims(x=c(-3,3), y=c(-3,3))
figures[['jaccard_mds_large_TRA']]
```


# Clonal overlap

## All

### TRA

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'overlap') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['overlap_all_tra']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)__TRA', '\\1', Var1),
         Var2 = gsub('(.+)__TRA', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(12.5,22.5, 34.5), color='red') + 
  geom_hline(yintercept = c(12.5,22.5, 34.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Overlap') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['overlap_all_tra']] 
```

### TRB

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'overlap') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['overlap_all_trb']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)__TRB', '\\1', Var1),
         Var2 = gsub('(.+)__TRB', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(12.5,22.5, 34.5), color='red') + 
  geom_hline(yintercept = c(12.5,22.5, 34.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Overlap') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['overlap_all_trb']] 
```

## Small

### TRA

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 size = include('S'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'overlap') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['overlap_small_tra']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)__TRA', '\\1', Var1),
         Var2 = gsub('(.+)__TRA', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,10.5, 16.5), color='red') + 
  geom_hline(yintercept = c(6.5,10.5, 16.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Overlap') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['overlap_small_tra']] 
```

### TRB

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'),
                 size = include('S'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'overlap') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['overlap_small_trb']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)__TRB', '\\1', Var1),
         Var2 = gsub('(.+)__TRB', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,10.5, 16.5), color='red') + 
  geom_hline(yintercept = c(6.5,10.5, 16.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Overlap') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['overlap_small_trb']] 
```

## Large

### TRA

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 size = include('L'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'overlap') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['overlap_large_tra']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)__TRA', '\\1', Var1),
         Var2 = gsub('(.+)__TRA', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,12.5, 18.5), color='red') + 
  geom_hline(yintercept = c(6.5,12.5, 18.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Overlap') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['overlap_large_tra']] 
```

### TRB

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'),
                 size = include('L'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'overlap') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['overlap_large_trb']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)__TRB', '\\1', Var1),
         Var2 = gsub('(.+)__TRB', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,12.5, 18.5), color='red') + 
  geom_hline(yintercept = c(6.5,12.5, 18.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Overlap') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['overlap_large_trb']] 
```

## MDS

### Small

#### TRB

```{r}
imm_ov1 <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'),
                 size = include('S'))) 
imm_ov1 <- repOverlap(.data = imm_ov1$data, .method = "overlap", .verbose = F)
imm_ov1 <- repOverlapAnalysis(imm_ov1, "mds") 
figures[['clonal_overlap_mds_small_TRB']] <-
  as.data.frame(imm_ov1$points) %>%
  rownames_to_column('Sample') %>%
  left_join(rep_data$meta, by='Sample') %>%
  mutate(V1=scale(V1), V2=scale(V2)) %>%
  ggplot(aes(x=V1, y=V2, color=kit, shape=individual)) +
  geom_point() +
  # stat_ellipse(aes(group=kit)) +
  lims(x=c(-3,3), y=c(-3,3))
figures[['clonal_overlap_mds_small_TRB']]
```

#### TRA

```{r}
imm_ov1 <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 size = include('S'))) 
imm_ov1 <- repOverlap(.data = imm_ov1$data, .method = "overlap", .verbose = F)
imm_ov1 <- repOverlapAnalysis(imm_ov1, "mds") 
figures[['clonal_overlap_mds_small_TRA']] <-
  as.data.frame(imm_ov1$points) %>%
  rownames_to_column('Sample') %>%
  left_join(rep_data$meta, by='Sample') %>%
  mutate(V1=scale(V1), V2=scale(V2)) %>%
  ggplot(aes(x=V1, y=V2, color=kit, shape=individual)) +
  geom_point() +
  lims(x=c(-3,3), y=c(-3,3))
figures[['clonal_overlap_mds_small_TRA']]
```

### Large

#### TRB

```{r}
imm_ov1 <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'),
                 size = include('L'))) 
imm_ov1 <- repOverlap(.data = imm_ov1$data, .method = "overlap", .verbose = F)
imm_ov1 <- repOverlapAnalysis(imm_ov1, "mds") 
figures[['clonal_overlap_mds_large_TRB']] <-
  as.data.frame(imm_ov1$points) %>%
  rownames_to_column('Sample') %>%
  left_join(rep_data$meta, by='Sample') %>%
  mutate(V1=scale(V1), V2=scale(V2)) %>%
  ggplot(aes(x=V1, y=V2, color=kit, shape=individual)) +
  geom_point() +
  lims(x=c(-3,3), y=c(-3,3))
figures[['clonal_overlap_mds_large_TRB']]
```

#### TRA

```{r}
imm_ov1 <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 size = include('L'))) 
imm_ov1 <- repOverlap(.data = imm_ov1$data, .method = "overlap", .verbose = F)
imm_ov1 <- repOverlapAnalysis(imm_ov1, "mds") 
figures[['clonal_overlap_mds_large_TRA']] <-
  as.data.frame(imm_ov1$points) %>%
  rownames_to_column('Sample') %>%
  left_join(rep_data$meta, by='Sample') %>%
  mutate(V1=scale(V1), V2=scale(V2)) %>%
  ggplot(aes(x=V1, y=V2, color=kit, shape=individual)) +
  geom_point() +
  lims(x=c(-3,3), y=c(-3,3))
figures[['clonal_overlap_mds_large_TRA']]
```


<!-- # Rank abundance plots -->

<!-- ## NEB -->

<!-- ### Replicates -->

<!-- ```{r, fig.height=6, fig.width=6} -->
<!-- plotdata <- repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(size = include('L'),# 'S'), -->
<!--                  kit = include('NEB'), -->
<!--                  individual = include('F1'), -->
<!--                  chain = include('TRA') -->
<!--             )) -->

<!-- plotdata <- lapply(plotdata$data, function(x) { -->
<!--   select(x, c('CDR3.aa', 'V.name', 'J.name', 'Proportion')) %>% -->
<!--     mutate(V.name = gsub('([^(]+)\\(.*', '\\1', x$V.name), -->
<!--            J.name = gsub('([^(]+)\\(.*', '\\1', x$J.name), -->
<!--            rank = rank(-Proportion)) -->
<!-- }) %>% -->
<!--   rbindlist(idcol='Sample') %>% -->
<!--   mutate(Sample = str_sub(Sample,1,  -6))  -->
<!-- plotdata <- plotdata %>% -->
<!--   full_join(plotdata, by=c('CDR3.aa', 'V.name', 'J.name'), suffix=c('_x', '_y'), relationship = "many-to-many") %>% -->
<!--   filter(Sample_x != Sample_y) %>% -->
<!--   filter(Sample_x == "N-F1LA") -->
<!--   # filter(pmin(rank_x, rank_y) < 100) -->
<!--   # filter(pmax(Proportion_x, Proportion_y) > 0.001) ## minimum 0.1% of one repertoire -->
<!-- fit <- cor(plotdata$Proportion_x, plotdata$Proportion_y, method = 'spearman') -->
<!-- figures[['clonal_abundance_neb_replicates_TRA']] <- ggplot(plotdata, aes(x=rank_x, y=rank_y)) + -->
<!--   geom_point(alpha=0.7, size=0.5) + -->
<!--   ggpubr::stat_cor(aes(x=Proportion_x, y=Proportion_y, label = paste(after_stat(rr.label), after_stat(p.label), sep = "~`,`~")), -->
<!--                    method='spearman', label.y=-0.5, label.x = 0, output.type = 'expression', size =2) + -->
<!--   scale_x_log10() + scale_y_log10() + -->
<!--   # scale_y_continuous(limits = c(-10, NA)) + -->
<!--   # facet_grid(Sample_x ~ Sample_y, scales='free') + -->
<!--   labs(x=unique(plotdata[['Sample_x']]), y=unique(plotdata[['Sample_y']]))  -->
<!-- figures[['clonal_abundance_neb_replicates_TRA']] -->
<!-- ``` -->

<!-- ### Small v large -->

<!-- ```{r, fig.height=6, fig.width=6} -->
<!-- plotdata <- repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(size = include('L', 'S'), -->
<!--                  kit = include('NEB'), -->
<!--                  individual = include('F2'), -->
<!--                  chain = include('TRA') -->
<!--             )) -->

<!-- plotdata <- lapply(plotdata$data, function(x) { -->
<!--   select(x, c('CDR3.aa', 'V.name', 'J.name', 'Proportion')) %>% -->
<!--     mutate(V.name = gsub('([^(]+)\\(.*', '\\1', x$V.name), -->
<!--            J.name = gsub('([^(]+)\\(.*', '\\1', x$J.name), -->
<!--            rank = rank(-Proportion)) -->
<!-- }) %>% -->
<!--   rbindlist(idcol='Sample') %>% -->
<!--   mutate(Sample = str_sub(Sample,1,  -6)) #%>% -->
<!--   # filter(grepl('N', Sample))  -->
<!-- plotdata <- plotdata %>% -->
<!--   full_join(plotdata, by=c('CDR3.aa', 'V.name', 'J.name'), suffix=c('_x', '_y'), relationship = "many-to-many") %>% -->
<!--   filter(Sample_x != Sample_y)# %>% -->
<!--   # filter(pmin(rank_x, rank_y) < 100) -->
<!--   # filter(pmax(Proportion_x, Proportion_y) > 0.001) ## minimum 0.1% of one repertoire -->
<!-- # fit <- round(cor(plotdata$Proportion_x, plotdata$Proportion_y, method = 'spearman'), 3) -->
<!-- figures[['clonal_abundance_neb_small_v_large_TRB']] <- ggplot(plotdata, aes(x=rank_x, y=rank_y)) + -->
<!--   geom_point(alpha=0.7, size=0.5) + -->
<!--   ggpubr::stat_cor(aes(x=Proportion_x, y=Proportion_y, label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), -->
<!--                    method='spearman', label.y=0, label.x = 0, output.type = 'expression', size =2) + -->
<!--   # geom_density_2d_filled() + -->
<!--   scale_x_log10() + scale_y_log10() + -->
<!--   # scale_y_continuous(limits = c(-10, NA)) + -->
<!--   facet_grid(Sample_y ~ Sample_x, scales='free') + -->
<!--   labs(x=unique(plotdata[['Sample_x']]), y=unique(plotdata[['Sample_y']]))  -->
<!-- figures[['clonal_abundance_neb_small_v_large_TRB']] -->
<!-- ``` -->

<!-- ### All -->

<!-- ```{r, fig.height=16, fig.width=16} -->
<!-- plotdata <- repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(size = include('L', 'S'), -->
<!--                  kit = include('NEB'), -->
<!--                  # individual = include('F1'), -->
<!--                  chain = include('TRA') -->
<!--             )) -->

<!-- plotdata <- lapply(plotdata$data, function(x) { -->
<!--   select(x, c('CDR3.aa', 'V.name', 'J.name', 'Proportion')) %>% -->
<!--     mutate(V.name = gsub('([^(]+)\\(.*', '\\1', x$V.name), -->
<!--            J.name = gsub('([^(]+)\\(.*', '\\1', x$J.name), -->
<!--            rank = rank(-Proportion)) -->
<!-- }) %>% -->
<!--   rbindlist(idcol='Sample') %>% -->
<!--   mutate(Sample = str_sub(Sample,1,  -6))  -->
<!-- plotdata <- plotdata %>% -->
<!--   full_join(plotdata, by=c('CDR3.aa', 'V.name', 'J.name'), suffix=c('_x', '_y'), relationship = "many-to-many") %>% -->
<!--   filter(Sample_x != Sample_y)# %>% -->
<!--   # filter(pmin(rank_x, rank_y) < 100) -->
<!--   # filter(pmax(Proportion_x, Proportion_y) > 0.001) ## minimum 0.1% of one repertoire -->
<!-- figures[['clonal_abundance_neb_all_TRA']] <- ggplot(plotdata, aes(x=rank_x, y=rank_y)) + -->
<!--   geom_point(alpha=0.7, size=0.5) + -->
<!--   ggpubr::stat_cor(aes(x=Proportion_x, y=Proportion_y, label = paste(after_stat(rr.label), after_stat(p.label), sep = "~`,`~")), -->
<!--                    method='spearman', label.y=-0.5, label.x = 0, output.type = 'expression', size =2) + -->
<!--   scale_x_log10() + scale_y_log10() + -->
<!--   # scale_y_continuous(limits = c(-10, NA)) + -->
<!--   facet_grid(Sample_y ~ Sample_x, scales='free') + -->
<!--   labs(x=unique(plotdata[['Sample_x']]), y=unique(plotdata[['Sample_y']]))  -->
<!-- figures[['clonal_abundance_neb_all_TRA']] -->
<!-- ``` -->

<!-- ## QiaSeq -->

<!-- ### Replicates -->

<!-- ```{r, fig.height=6, fig.width=6} -->
<!-- plotdata <- repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(size = include('L'),# 'S'), -->
<!--                  kit = include('QiaSeq'), -->
<!--                  individual = include('F1'), -->
<!--                  chain = include('TRA') -->
<!--             )) -->

<!-- plotdata <- lapply(plotdata$data, function(x) { -->
<!--   select(x, c('CDR3.aa', 'V.name', 'J.name', 'Proportion')) %>% -->
<!--     mutate(V.name = gsub('([^(]+)\\(.*', '\\1', x$V.name), -->
<!--            J.name = gsub('([^(]+)\\(.*', '\\1', x$J.name), -->
<!--            rank = rank(-Proportion)) -->
<!-- }) %>% -->
<!--   rbindlist(idcol='Sample') %>% -->
<!--   mutate(Sample = str_sub(Sample,1,  -6))  -->
<!-- plotdata <- plotdata %>% -->
<!--   full_join(plotdata, by=c('CDR3.aa', 'V.name', 'J.name'), suffix=c('_x', '_y'), relationship = "many-to-many") %>% -->
<!--   filter(Sample_x != Sample_y) %>% -->
<!--   filter(Sample_x == "Q-F1LA") -->
<!--   # filter(pmin(rank_x, rank_y) < 100) -->
<!--   # filter(pmax(Proportion_x, Proportion_y) > 0.001) ## minimum 0.1% of one repertoire -->
<!-- fit <- cor(plotdata$Proportion_x, plotdata$Proportion_y, method = 'spearman') -->
<!-- figures[['clonal_abundance_qiaseq_replicates_TRA']] <- ggplot(plotdata, aes(x=rank_x, y=rank_y)) + -->
<!--   geom_point(alpha=0.7, size=0.5) + -->
<!--   ggpubr::stat_cor(aes(x=Proportion_x, y=Proportion_y, label = paste(after_stat(rr.label), after_stat(p.label), sep = "~`,`~")), -->
<!--                    method='spearman', label.y=-0.5, label.x = 0, output.type = 'expression', size =2) + -->
<!--   scale_x_log10() + scale_y_log10() + -->
<!--   # scale_y_continuous(limits = c(-10, NA)) + -->
<!--   # facet_grid(Sample_x ~ Sample_y, scales='free') + -->
<!--   labs(x=unique(plotdata[['Sample_x']]), y=unique(plotdata[['Sample_y']]))  -->
<!-- figures[['clonal_abundance_qiaseq_replicates_TRA']] -->
<!-- ``` -->

<!-- ### Small v large -->

<!-- ```{r, fig.height=6, fig.width=6} -->
<!-- plotdata <- repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(size = include('L', 'S'), -->
<!--                  kit = include('QiaSeq'), -->
<!--                  individual = include('F2'), -->
<!--                  chain = include('TRA') -->
<!--             )) -->

<!-- plotdata <- lapply(plotdata$data, function(x) { -->
<!--   select(x, c('CDR3.aa', 'V.name', 'J.name', 'Proportion')) %>% -->
<!--     mutate(V.name = gsub('([^(]+)\\(.*', '\\1', x$V.name), -->
<!--            J.name = gsub('([^(]+)\\(.*', '\\1', x$J.name), -->
<!--            rank = rank(-Proportion)) -->
<!-- }) %>% -->
<!--   rbindlist(idcol='Sample') %>% -->
<!--   mutate(Sample = str_sub(Sample,1,  -6)) #%>% -->
<!--   # filter(grepl('N', Sample))  -->
<!-- plotdata <- plotdata %>% -->
<!--   full_join(plotdata, by=c('CDR3.aa', 'V.name', 'J.name'), suffix=c('_x', '_y'), relationship = "many-to-many") %>% -->
<!--   filter(Sample_x != Sample_y)# %>% -->
<!--   # filter(pmin(rank_x, rank_y) < 100) -->
<!--   # filter(pmax(Proportion_x, Proportion_y) > 0.001) ## minimum 0.1% of one repertoire -->
<!-- # fit <- round(cor(plotdata$Proportion_x, plotdata$Proportion_y, method = 'spearman'), 3) -->
<!-- figures[['clonal_abundance_qiaseq_small_v_large_TRB']] <- ggplot(plotdata, aes(x=rank_x, y=rank_y)) + -->
<!--   geom_point(alpha=0.7, size=0.5) + -->
<!--   ggpubr::stat_cor(aes(x=Proportion_x, y=Proportion_y, label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), -->
<!--                    method='spearman', label.y=0, label.x = 0, output.type = 'expression', size =2) + -->
<!--   # geom_density_2d_filled() + -->
<!--   scale_x_log10() + scale_y_log10() + -->
<!--   # scale_y_continuous(limits = c(-10, NA)) + -->
<!--   facet_grid(Sample_y ~ Sample_x, scales='free') + -->
<!--   labs(x=unique(plotdata[['Sample_x']]), y=unique(plotdata[['Sample_y']]))  -->
<!-- figures[['clonal_abundance_qiaseq_small_v_large_TRB']] -->
<!-- ``` -->

<!-- ### All -->

<!-- ```{r, fig.height=16, fig.width=16} -->
<!-- plotdata <- repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(size = include('L', 'S'), -->
<!--                  kit = include('QiaSeq'), -->
<!--                  # individual = include('F1'), -->
<!--                  chain = include('TRA') -->
<!--             )) -->

<!-- plotdata <- lapply(plotdata$data, function(x) { -->
<!--   select(x, c('CDR3.aa', 'V.name', 'J.name', 'Proportion')) %>% -->
<!--     mutate(V.name = gsub('([^(]+)\\(.*', '\\1', x$V.name), -->
<!--            J.name = gsub('([^(]+)\\(.*', '\\1', x$J.name), -->
<!--            rank = rank(-Proportion)) -->
<!-- }) %>% -->
<!--   rbindlist(idcol='Sample') %>% -->
<!--   mutate(Sample = str_sub(Sample,1,  -6))  -->
<!-- plotdata <- plotdata %>% -->
<!--   full_join(plotdata, by=c('CDR3.aa', 'V.name', 'J.name'), suffix=c('_x', '_y'), relationship = "many-to-many") %>% -->
<!--   filter(Sample_x != Sample_y)# %>% -->
<!--   # filter(pmin(rank_x, rank_y) < 100) -->
<!--   # filter(pmax(Proportion_x, Proportion_y) > 0.001) ## minimum 0.1% of one repertoire -->
<!-- figures[['clonal_abundance_qiaseq_all_TRA']] <- ggplot(plotdata, aes(x=rank_x, y=rank_y)) + -->
<!--   geom_point(alpha=0.7, size=0.5) + -->
<!--   ggpubr::stat_cor(aes(x=Proportion_x, y=Proportion_y, label = paste(after_stat(rr.label), after_stat(p.label), sep = "~`,`~")), -->
<!--                    method='spearman', label.y=-0.5, label.x = 0, output.type = 'expression', size =2) + -->
<!--   scale_x_log10() + scale_y_log10() + -->
<!--   # scale_y_continuous(limits = c(-10, NA)) + -->
<!--   facet_grid(Sample_x ~ Sample_y, scales='free') + -->
<!--   labs(x=unique(plotdata[['Sample_x']]), y=unique(plotdata[['Sample_y']]))  -->
<!-- figures[['clonal_abundance_qiaseq_all_TRA']] -->
<!-- ``` -->

<!-- ## Takara -->

<!-- ### Replicates -->

<!-- ```{r, fig.height=6, fig.width=6} -->
<!-- plotdata <- repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(size = include('L'),# 'S'), -->
<!--                  kit = include('Takara'), -->
<!--                  individual = include('F1'), -->
<!--                  chain = include('TRA') -->
<!--             )) -->

<!-- plotdata <- lapply(plotdata$data, function(x) { -->
<!--   select(x, c('CDR3.aa', 'V.name', 'J.name', 'Proportion')) %>% -->
<!--     mutate(V.name = gsub('([^(]+)\\(.*', '\\1', x$V.name), -->
<!--            J.name = gsub('([^(]+)\\(.*', '\\1', x$J.name), -->
<!--            rank = rank(-Proportion)) -->
<!-- }) %>% -->
<!--   rbindlist(idcol='Sample') %>% -->
<!--   mutate(Sample = str_sub(Sample,1,  -6))  -->
<!-- plotdata <- plotdata %>% -->
<!--   full_join(plotdata, by=c('CDR3.aa', 'V.name', 'J.name'), suffix=c('_x', '_y'), relationship = "many-to-many") %>% -->
<!--   filter(Sample_x != Sample_y) %>% -->
<!--   filter(Sample_x == "T-F1LA") -->
<!--   # filter(pmin(rank_x, rank_y) < 100) -->
<!--   # filter(pmax(Proportion_x, Proportion_y) > 0.001) ## minimum 0.1% of one repertoire -->
<!-- fit <- cor(plotdata$Proportion_x, plotdata$Proportion_y, method = 'spearman') -->
<!-- figures[['clonal_abundance_takara_replicates_TRA']] <- ggplot(plotdata, aes(x=rank_x, y=rank_y)) + -->
<!--   geom_point(alpha=0.7, size=0.5) + -->
<!--   ggpubr::stat_cor(aes(x=Proportion_x, y=Proportion_y, label = paste(after_stat(rr.label), after_stat(p.label), sep = "~`,`~")), -->
<!--                    method='spearman', label.y=-0.5, label.x = 0, output.type = 'expression', size =2) + -->
<!--   scale_x_log10() + scale_y_log10() + -->
<!--   # scale_y_continuous(limits = c(-10, NA)) + -->
<!--   # facet_grid(Sample_x ~ Sample_y, scales='free') + -->
<!--   labs(x=unique(plotdata[['Sample_x']]), y=unique(plotdata[['Sample_y']]))  -->
<!-- figures[['clonal_abundance_takara_replicates_TRA']] -->
<!-- ``` -->

<!-- ### Small v large -->

<!-- ```{r, fig.height=6, fig.width=6} -->
<!-- plotdata <- repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(size = include('L', 'S'), -->
<!--                  kit = include('Takara'), -->
<!--                  individual = include('F2'), -->
<!--                  chain = include('TRA') -->
<!--             )) -->

<!-- plotdata <- lapply(plotdata$data, function(x) { -->
<!--   select(x, c('CDR3.aa', 'V.name', 'J.name', 'Proportion')) %>% -->
<!--     mutate(V.name = gsub('([^(]+)\\(.*', '\\1', x$V.name), -->
<!--            J.name = gsub('([^(]+)\\(.*', '\\1', x$J.name), -->
<!--            rank = rank(-Proportion)) -->
<!-- }) %>% -->
<!--   rbindlist(idcol='Sample') %>% -->
<!--   mutate(Sample = str_sub(Sample,1,  -6)) #%>% -->
<!--   # filter(grepl('N', Sample))  -->
<!-- plotdata <- plotdata %>% -->
<!--   full_join(plotdata, by=c('CDR3.aa', 'V.name', 'J.name'), suffix=c('_x', '_y'), relationship = "many-to-many") %>% -->
<!--   filter(Sample_x != Sample_y)# %>% -->
<!--   # filter(pmin(rank_x, rank_y) < 100) -->
<!--   # filter(pmax(Proportion_x, Proportion_y) > 0.001) ## minimum 0.1% of one repertoire -->
<!-- # fit <- round(cor(plotdata$Proportion_x, plotdata$Proportion_y, method = 'spearman'), 3) -->
<!-- figures[['clonal_abundance_takara_small_v_large_TRB']] <- ggplot(plotdata, aes(x=rank_x, y=rank_y)) + -->
<!--   geom_point(alpha=0.7, size=0.5) + -->
<!--   ggpubr::stat_cor(aes(x=Proportion_x, y=Proportion_y, label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), -->
<!--                    method='spearman', label.y=0, label.x = 0, output.type = 'expression', size =2) + -->
<!--   # geom_density_2d_filled() + -->
<!--   scale_x_log10() + scale_y_log10() + -->
<!--   # scale_y_continuous(limits = c(-10, NA)) + -->
<!--   facet_grid(Sample_y ~ Sample_x, scales='free') + -->
<!--   labs(x=unique(plotdata[['Sample_x']]), y=unique(plotdata[['Sample_y']]))  -->
<!-- figures[['clonal_abundance_takara_small_v_large_TRB']] -->
<!-- ``` -->

<!-- ### All -->

<!-- ```{r, fig.height=16, fig.width=16} -->
<!-- plotdata <- repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(size = include('L', 'S'), -->
<!--                  kit = include('Takara'), -->
<!--                  # individual = include('F1'), -->
<!--                  chain = include('TRA') -->
<!--             )) -->

<!-- plotdata <- lapply(plotdata$data, function(x) { -->
<!--   select(x, c('CDR3.aa', 'V.name', 'J.name', 'Proportion')) %>% -->
<!--     mutate(V.name = gsub('([^(]+)\\(.*', '\\1', x$V.name), -->
<!--            J.name = gsub('([^(]+)\\(.*', '\\1', x$J.name), -->
<!--            rank = rank(-Proportion)) -->
<!-- }) %>% -->
<!--   rbindlist(idcol='Sample') %>% -->
<!--   mutate(Sample = str_sub(Sample,1,  -6))  -->
<!-- plotdata <- plotdata %>% -->
<!--   full_join(plotdata, by=c('CDR3.aa', 'V.name', 'J.name'), suffix=c('_x', '_y'), relationship = "many-to-many") %>% -->
<!--   filter(Sample_x != Sample_y)# %>% -->
<!--   # filter(pmin(rank_x, rank_y) < 100) -->
<!--   # filter(pmax(Proportion_x, Proportion_y) > 0.001) ## minimum 0.1% of one repertoire -->
<!-- figures[['clonal_abundance_takara_all_TRA']] <- ggplot(plotdata, aes(x=rank_x, y=rank_y)) + -->
<!--   geom_point(alpha=0.7, size=0.5) + -->
<!--   ggpubr::stat_cor(aes(x=Proportion_x, y=Proportion_y, label = paste(after_stat(rr.label), after_stat(p.label), sep = "~`,`~")), -->
<!--                    method='spearman', label.y=-0.5, label.x = 0, output.type = 'expression', size =2) + -->
<!--   scale_x_log10() + scale_y_log10() + -->
<!--   # scale_y_continuous(limits = c(-10, NA)) + -->
<!--   facet_grid(Sample_y ~ Sample_x, scales='free') + -->
<!--   labs(x=unique(plotdata[['Sample_x']]), y=unique(plotdata[['Sample_y']]))  -->
<!-- figures[['clonal_abundance_takara_all_TRA']] -->
<!-- ``` -->

<!-- ## Cellecta -->

<!-- ### Replicates -->

<!-- ```{r, fig.height=6, fig.width=6} -->
<!-- plotdata <- repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(size = include('L'),# 'S'), -->
<!--                  kit = include('Cellecta'), -->
<!--                  individual = include('F1'), -->
<!--                  chain = include('TRA') -->
<!--             )) -->

<!-- plotdata <- lapply(plotdata$data, function(x) { -->
<!--   select(x, c('CDR3.aa', 'V.name', 'J.name', 'Proportion')) %>% -->
<!--     mutate(V.name = gsub('([^(]+)\\(.*', '\\1', x$V.name), -->
<!--            J.name = gsub('([^(]+)\\(.*', '\\1', x$J.name), -->
<!--            rank = rank(-Proportion)) -->
<!-- }) %>% -->
<!--   rbindlist(idcol='Sample') %>% -->
<!--   mutate(Sample = str_sub(Sample,1,  -6))  -->
<!-- plotdata <- plotdata %>% -->
<!--   full_join(plotdata, by=c('CDR3.aa', 'V.name', 'J.name'), suffix=c('_x', '_y'), relationship = "many-to-many") %>% -->
<!--   filter(Sample_x != Sample_y) %>% -->
<!--   filter(Sample_x == "C-F1LA") -->
<!--   # filter(pmin(rank_x, rank_y) < 100) -->
<!--   # filter(pmax(Proportion_x, Proportion_y) > 0.001) ## minimum 0.1% of one repertoire -->
<!-- fit <- cor(plotdata$Proportion_x, plotdata$Proportion_y, method = 'spearman') -->
<!-- figures[['clonal_abundance_cellecta_replicates_TRA']] <- ggplot(plotdata, aes(x=rank_x, y=rank_y)) + -->
<!--   geom_point(alpha=0.7, size=0.5) + -->
<!--   ggpubr::stat_cor(aes(x=Proportion_x, y=Proportion_y, label = paste(after_stat(rr.label), after_stat(p.label), sep = "~`,`~")), -->
<!--                    method='spearman', label.y=-0.5, label.x = 0, output.type = 'expression', size =2) + -->
<!--   scale_x_log10() + scale_y_log10() + -->
<!--   # scale_y_continuous(limits = c(-10, NA)) + -->
<!--   # facet_grid(Sample_x ~ Sample_y, scales='free') + -->
<!--   labs(x=unique(plotdata[['Sample_x']]), y=unique(plotdata[['Sample_y']]))  -->
<!-- figures[['clonal_abundance_cellecta_replicates_TRA']] -->
<!-- ``` -->

<!-- ### Small v large -->

<!-- ```{r, fig.height=6, fig.width=6} -->
<!-- plotdata <- repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(size = include('L', 'S'), -->
<!--                  kit = include('Cellecta'), -->
<!--                  individual = include('F2'), -->
<!--                  chain = include('TRA') -->
<!--             )) -->

<!-- plotdata <- lapply(plotdata$data, function(x) { -->
<!--   select(x, c('CDR3.aa', 'V.name', 'J.name', 'Proportion')) %>% -->
<!--     mutate(V.name = gsub('([^(]+)\\(.*', '\\1', x$V.name), -->
<!--            J.name = gsub('([^(]+)\\(.*', '\\1', x$J.name), -->
<!--            rank = rank(-Proportion)) -->
<!-- }) %>% -->
<!--   rbindlist(idcol='Sample') %>% -->
<!--   mutate(Sample = str_sub(Sample,1,  -6)) #%>% -->
<!--   # filter(grepl('N', Sample))  -->
<!-- plotdata <- plotdata %>% -->
<!--   full_join(plotdata, by=c('CDR3.aa', 'V.name', 'J.name'), suffix=c('_x', '_y'), relationship = "many-to-many") %>% -->
<!--   filter(Sample_x != Sample_y)# %>% -->
<!--   # filter(pmin(rank_x, rank_y) < 100) -->
<!--   # filter(pmax(Proportion_x, Proportion_y) > 0.001) ## minimum 0.1% of one repertoire -->
<!-- # fit <- round(cor(plotdata$Proportion_x, plotdata$Proportion_y, method = 'spearman'), 3) -->
<!-- figures[['clonal_abundance_cellecta_small_v_large_TRB']] <- ggplot(plotdata, aes(x=rank_x, y=rank_y)) + -->
<!--   geom_point(alpha=0.7, size=0.5) + -->
<!--   ggpubr::stat_cor(aes(x=Proportion_x, y=Proportion_y, label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), -->
<!--                    method='spearman', label.y=0, label.x = 0, output.type = 'expression', size =2) + -->
<!--   # geom_density_2d_filled() + -->
<!--   scale_x_log10() + scale_y_log10() + -->
<!--   # scale_y_continuous(limits = c(-10, NA)) + -->
<!--   facet_grid(Sample_y ~ Sample_x, scales='free') + -->
<!--   labs(x=unique(plotdata[['Sample_x']]), y=unique(plotdata[['Sample_y']]))  -->
<!-- figures[['clonal_abundance_cellecta_small_v_large_TRB']] -->
<!-- ``` -->

<!-- ### All -->

<!-- ```{r, fig.height=16, fig.width=16} -->
<!-- plotdata <- repFilter(rep_data, -->
<!--             .method = 'by.meta', -->
<!--             list(size = include('L', 'S'), -->
<!--                  kit = include('Cellecta'), -->
<!--                  # individual = include('F1'), -->
<!--                  chain = include('TRA') -->
<!--             )) -->

<!-- plotdata <- lapply(plotdata$data, function(x) { -->
<!--   select(x, c('CDR3.aa', 'V.name', 'J.name', 'Proportion')) %>% -->
<!--     mutate(V.name = gsub('([^(]+)\\(.*', '\\1', x$V.name), -->
<!--            J.name = gsub('([^(]+)\\(.*', '\\1', x$J.name), -->
<!--            rank = rank(-Proportion)) -->
<!-- }) %>% -->
<!--   rbindlist(idcol='Sample') %>% -->
<!--   mutate(Sample = str_sub(Sample,1,  -6))  -->
<!-- plotdata <- plotdata %>% -->
<!--   full_join(plotdata, by=c('CDR3.aa', 'V.name', 'J.name'), suffix=c('_x', '_y'), relationship = "many-to-many") %>% -->
<!--   filter(Sample_x != Sample_y)# %>% -->
<!--   # filter(pmin(rank_x, rank_y) < 100) -->
<!--   # filter(pmax(Proportion_x, Proportion_y) > 0.001) ## minimum 0.1% of one repertoire -->
<!-- figures[['clonal_abundance_cellecta_all_TRA']] <- ggplot(plotdata, aes(x=rank_x, y=rank_y)) + -->
<!--   geom_point(alpha=0.7, size=0.5) + -->
<!--   ggpubr::stat_cor(aes(x=Proportion_x, y=Proportion_y, label = paste(after_stat(rr.label), after_stat(p.label), sep = "~`,`~")), -->
<!--                    method='spearman', label.y=-0.5, label.x = 0, output.type = 'expression', size =2) + -->
<!--   scale_x_log10() + scale_y_log10() + -->
<!--   # scale_y_continuous(limits = c(-10, NA)) + -->
<!--   facet_grid(Sample_y ~ Sample_x, scales='free') + -->
<!--   labs(x=unique(plotdata[['Sample_x']]), y=unique(plotdata[['Sample_y']]))  -->
<!-- figures[['clonal_abundance_cellecta_all_TRA']] -->
<!-- ``` -->

# rank abundance corr

```{r, fig.height=16, fig.width=16}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(size = include('L', 'S'),
                 # kit = include('Cellecta'),
                 # individual = include('F1'),
                 chain = include('TRA')
            ))

plotdata <- lapply(plotdata$data, function(x) {
  select(x, c('CDR3.aa', 'V.name', 'J.name', 'Proportion')) %>%
    mutate(V.name = gsub('([^(]+)\\(.*', '\\1', x$V.name),
           J.name = gsub('([^(]+)\\(.*', '\\1', x$J.name),
           rank = rank(-Proportion))
}) %>%
  rbindlist(idcol='Sample') %>%
  mutate(Sample = str_sub(Sample,1,  -6)) 
plotdata <- plotdata %>%
  full_join(plotdata, by=c('CDR3.aa', 'V.name', 'J.name'), suffix=c('_x', '_y'), relationship = "many-to-many") %>%
  filter(Sample_x != Sample_y)# %>%
  # filter(pmin(rank_x, rank_y) < 100)
  # filter(pmax(Proportion_x, Proportion_y) > 0.001) ## minimum 0.1% of one repertoire
corr_data <- matrix(0, nrow = length(unique(plotdata$Sample_x)), ncol = length(unique(plotdata$Sample_y)), 
                    dimnames = list(unique(plotdata$Sample_x), unique(plotdata$Sample_y))) 
for (sample1 in unique(plotdata$Sample_x)) {
  for (sample2 in unique(plotdata$Sample_x)) {
    tmp <- plotdata %>%
      filter(Sample_x == sample1, 
             Sample_y == sample2)
    corr_data[sample1, sample2] <- cor(tmp$Proportion_x, tmp$Proportion_y, method = 'spearman')
  }
}
```

## By individual

### 2

```{r}

plotdata <- as.data.table(corr_data, keep.rownames=TRUE) %>% 
  melt()
plotdata <- plotdata %>%
  filter(grepl('2', rn) & grepl('2', variable))
plotdata <- plotdata %>%
  mutate(rn = factor(rn, levels = gtools::mixedsort(unique(plotdata$rn))),
         variable = factor(variable, levels = gtools::mixedsort(unique(plotdata$rn)))) %>%
    arrange(rn, variable) 
figures[['spearman_cor_F2']] <-
(ggplot(plotdata, aes(x=rn, y=variable, fill = value)) +
  geom_tile() +
  xlim(levels(plotdata$rn)) + ylim(levels(plotdata$variable)) +
  scale_fill_viridis_c(option='plasma') +
  theme(axis.text.x = element_text(angle=90)) +
  geom_vline(xintercept = c(4.5, 8.5, 12.5)) +
  geom_hline(yintercept = c(4.5, 8.5, 12.5)) +
  labs(x=NULL, y=NULL, fill = 'Corr')) #%>%
  # ggplotly()
figures[['spearman_cor_F2']]
```

### 1

```{r}
plotdata <- as.data.table(corr_data, keep.rownames=TRUE) %>% 
  melt()
plotdata <- plotdata %>%
  filter(grepl('1', rn) & grepl('1', variable))
plotdata <- plotdata %>%
  mutate(rn = factor(rn, levels = gtools::mixedsort(unique(plotdata$rn))),
         variable = factor(variable, levels = gtools::mixedsort(unique(plotdata$rn)))) %>%
    arrange(rn, variable) 

figures[['spearman_cor_F1']] <-
ggplot(plotdata, aes(x=rn, y=variable, fill = value)) +
  geom_tile() +
  xlim(levels(plotdata$rn)) + ylim(levels(plotdata$variable)) +
  scale_fill_viridis_c(option='plasma') +
  theme(axis.text.x = element_text(angle=90)) +
  geom_vline(xintercept = c(4.5, 7.5, 11.5)) +
  geom_hline(yintercept = c(4.5, 7.5, 11.5)) +
  labs(x=NULL, y=NULL, fill = 'Corr')
figures[['spearman_cor_F1']] 
```

## All

```{r}
plotdata <- as.data.table(corr_data, keep.rownames=TRUE) %>% 
  melt()
# plotdata <- plotdata %>%
  # filter(grepl('2', rn) & grepl('2', variable))
plotdata <- plotdata %>%
  mutate(rn = factor(rn, levels = gtools::mixedsort(unique(plotdata$rn))),
         variable = factor(variable, levels = gtools::mixedsort(unique(plotdata$rn)))) %>%
    arrange(rn, variable) 
figures[['spearman_cor_all']] <-
ggplot(plotdata, aes(x=rn, y=variable, fill = value)) +
  geom_tile() +
  xlim(levels(plotdata$rn)) + ylim(levels(plotdata$variable)) +
  scale_fill_viridis_c(option='plasma') +
  theme(axis.text.x = element_text(angle=90, vjust = 0.5)) +
  geom_vline(xintercept = c(12.5, 22.5, 34.5)) +
  geom_hline(yintercept = c(12.5, 22.5, 34.5)) +
  labs(x=NULL, y=NULL, fill = 'Corr')
figures[['spearman_cor_all']]
```

# Render report

```{r}
## This only works if all the variables called in the format file 
## are in the current environment. Check the format file to tweak aesthetics 

if (dataset == 'downsampled_by_read') {
  outfile <- '02_analysis_downsample_by_reads.html'
} else if (dataset == 'downsampled_by_umi') {
  outfile <- '02_analysis_downsample_by_umi.html'
} else if (dataset == 'full') {
  outfile <- '02_analysis_full_data.html' 
}

rmarkdown::render(here('scripts/02-analysis.format.Rmd'),
                  output_file = outfile,
                  output_dir = here('reports'))
```