---
title: 'TCR QC'
author: "FHIL\nDerrikGratz"
date: '`r Sys.Date()`'
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      fig.width = 8, fig.height = 6,
                      cache=FALSE, cache.lazy = FALSE, dev='svg') 

library(tidyverse)  ## General R logic
library(here)       ## Easier specification of file locations
library(immunarch)  ## MixCR output parsing and stats
library(khroma)     ## colorblind friendly palettes
# library(yaml)       ## parses config yaml
# library(reshape2)   ## DF manipulation
# library(jsonlite)   ## Parse QC json
library(ggbeeswarm) ## swarm plots
library(ggh4x) ## Nested facet plots
library(plotly)
rbindlist <- data.table::rbindlist
str_match <- stringr::str_match

set.seed(44)
```

```{r}
figures <- list()
```

# Functions

```{r}
parse_name <- function(x) {
  x <- as.data.frame(str_match(x, '(^.)-(F\\d)(L|S)(A|B)?_?(.+)?'))
  colnames(x) <- c(
    'sample', 'kit', 'individual', 'size', 'replicate', 'chain'
  )
  x %>%
    mutate(
      replicate = if_else(is.na(replicate), 'A', replicate),
      kit = case_when(
        kit == 'N' ~ 'NEB',
        kit == 'Q' ~ 'QiaSeq',
        kit == 'T' ~ 'Takara',
        .default = 'unknown'
      )
    )
}
```

# Pipeline QC

```{r}
data_dir <- c(here('../processing/mixcr/qiaseq/umi18'),
              here('../processing/mixcr/neb'),
              here('../processing/mixcr/takara'))
```

```{r}
qc_metrics <- list.files(path = data_dir, pattern = '*.qc.txt', recursive = TRUE, full.names = TRUE)
names(qc_metrics) <- gsub('.+(.-F\\w+).+', '\\1', qc_metrics)
qc_metrics <- lapply(qc_metrics, read.table, sep=':', strip.white=TRUE)
qc_metrics <- data.table::rbindlist(qc_metrics, idcol='sample')
qc_metrics <- qc_metrics %>%
  separate(V2, c('value', 'status'), sep = '\\[', ) %>%
  mutate(value = readr::parse_number(value)) %>%
  mutate(status = substr(status, 1, nchar(status)-1)) %>%
  mutate(status = factor(status, levels = c('OK', 'WARN', 'ALERT')))
```


```{r}
qc_metadata <- rbindlist(lapply(unique(qc_metrics$sample), parse_name))
qc_metadata <- qc_metadata %>%
  mutate(across(everything(),
                ~ factor(., levels = gtools::mixedsort(unique(.)))
                ))
```

```{r, fig.width=10, fig.height=8}
metrics <- c(
  "Successfully aligned reads",
  "Off target (non TCR/IG) reads", 
  "Reads with no V or J hits",
  "Reads used in clonotypes", 
  "Alignments that do not cover CDR3", 
  "Unassigned alignments in clonotype assembly" ,
  "UMIs artificial diversity eliminated", 
  "Reads dropped in tags error correction and filtering",
  "Barcode collisions in clonotype assembly"
)
figures[['QC_large']] <-
  left_join(qc_metrics, qc_metadata, by='sample') %>%
  filter(grepl('L', sample)) %>%
  filter(V1 %in% metrics) %>% 
  # mutate(V1 = factor(V1, levels=metrics)) %>%
ggplot(aes(x=kit, y=value)) +
  geom_boxplot(outliers = FALSE) +
  geom_beeswarm(aes(color=status, shape=individual), size=2) +
  theme_bw() + 
  scale_color_manual(values = c("OK"='#34C400', 'WARN'='goldenrod', 'ALERT'='#F54411')) +
  # theme(text = element_text(family='Courier', size = 11)) +
  # theme(axis.title.x=element_blank(),
  #       axis.text.x=element_blank(),
  #       axis.ticks.x=element_blank()) +
  facet_wrap(~V1, scales = 'free', labeller = label_wrap_gen(40), ncol=3) +
  labs(x='Sample', y='Value (%)', color='MixCR\nstatus')

figures[['QC_large']]
```

```{r, fig.width=10, fig.height=8}
metrics <- c(
  "Successfully aligned reads",
  "Off target (non TCR/IG) reads", 
  "Reads with no V or J hits",
  "Reads used in clonotypes", 
  "Alignments that do not cover CDR3", 
  "Unassigned alignments in clonotype assembly" ,
  "UMIs artificial diversity eliminated", 
  "Reads dropped in tags error correction and filtering",
  "Barcode collisions in clonotype assembly"
)
figures[['QC_small']] <-
  left_join(qc_metrics, qc_metadata, by='sample') %>%
  filter(grepl('S', sample)) %>%
  filter(V1 %in% metrics) %>% 
  # mutate(V1 = factor(V1, levels=metrics)) %>%
ggplot(aes(x=kit, y=value)) +
  geom_boxplot(outliers = FALSE) +
  geom_beeswarm(aes(color=status, shape=individual), size=2) +
  theme_bw() + 
  scale_color_manual(values = c("OK"='#34C400', 'WARN'='goldenrod', 'ALERT'='#F54411')) +
  # theme(text = element_text(family='Courier', size = 11)) +
  # theme(axis.title.x=element_blank(),
  #       axis.text.x=element_blank(),
  #       axis.ticks.x=element_blank()) +
  facet_wrap(~V1, scales = 'free', labeller = label_wrap_gen(40), ncol=3) +
  labs(x='Sample', y='Value (%)', color='MixCR\nstatus')

figures[['QC_small']]
```

# Load TCR data

```{r}
rep_data <- repLoad(data_dir)

#parse metadata from samplenames, based on previous function
metadata <- as_tibble(rbindlist(lapply(names(rep_data$data), parse_name)))
metadata <- metadata %>%
  mutate(Sample = sample,
         sample = NULL)
metadata$chain[is.na(metadata$chain)] <- 'other'
metadata$chain <- factor(metadata$chain, 
                         levels = c(
                           'TRA', 'TRB',
                           'TRD', 'TRG',
                           'ILH', 'IGK', 'IGL',
                           'other'
                         ))

rep_data$meta <- metadata
```

# Clone count

## Large

### TRATRB

```{r}
figures[['chain_recovery_large_TRATRB']] <- 
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('L'))) %>%
  repExplore(.data = .[['data']], .method = c("clones")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Clones)) +
  geom_boxplot() +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=2) +
  labs(x='Kit', y='Total recovery')
figures[['chain_recovery_large_TRATRB']]
```

### Other

```{r}
figures[['chain_recovery_large_other']] <- 
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = exclude('TRA', 'TRB'),
                 size = include('L'))) %>%
  repExplore(.data = .[['data']], .method = c("clones")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Clones)) +
  geom_boxplot() +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  facet_wrap(~chain, strip.position = 'top', ncol=3, scales = 'free_y') +
  labs(x='Kit', y='Total recovery')
figures[['chain_recovery_large_other']]
```

## Small

### TRATRB

```{r}
figures[['chain_recovery_small_TRATRB']] <- 
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('S'))) %>%
  repExplore(.data = .[['data']], .method = c("clones")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Clones)) +
  geom_boxplot() +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=2) +
  labs(x='Kit', y='Total recovery')
figures[['chain_recovery_small_TRATRB']]
```

### Other

```{r}
figures[['chain_recovery_other_small']] <- 
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = exclude('TRA', 'TRB'),
                 size = include('S'))) %>%
  repExplore(.data = .[['data']], .method = c("clones")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Clones)) +
  geom_boxplot() +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  facet_wrap(~chain, strip.position = 'top', ncol=3, scales = 'free_y') +
  labs(x='Kit', y='Total recovery')
figures[['chain_recovery_other_small']]
```

# Chain recovery

## Large

### TRATRB

```{r}
figures[['chain_recovery_large_TRATRB']] <- 
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('L'))) %>%
  repExplore(.data = .[['data']], .method = c("volume")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Volume)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=2) +
  labs(x='Chain', y='Total recovery')
figures[['chain_recovery_large_TRATRB']]
```

### Other

```{r}
figures[['chain_recovery_large_other']] <- 
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = exclude('TRA', 'TRB'),
                 size = include('L'))) %>%
  repExplore(.data = .[['data']], .method = c("volume")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Volume)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=3) +
  labs(x='Chain', y='Total recovery')
figures[['chain_recovery_large_other']]
```

## Small

### TRATRB

```{r}
figures[['chain_recovery_small_TRATRB']] <- 
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('S'))) %>%
  repExplore(.data = .[['data']], .method = c("volume")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Volume)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=2) +
  labs(x='Chain', y='Total recovery')
figures[['chain_recovery_small_TRATRB']]
```

### Other

```{r}
figures[['chain_recovery_small_other']] <- 
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = exclude('TRA', 'TRB'),
                 size = include('S'))) %>%
  repExplore(.data = .[['data']], .method = c("volume")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Volume)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=3) +
  labs(x='Chain', y='Total recovery')
figures[['chain_recovery_small_other']]
```

# Unique clone count

## Large

### TRATRB

```{r}
figures[['unique_clones_large_TRATRB']] <- 
   repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('L'))) %>%
  repExplore(.data = .[['data']], .method = c("volume")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Volume)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=2) +
  labs(x='Chain', y='Unique clones')
figures[['unique_clones_large_TRATRB']]
```

### other

```{r}
figures[['unique_clones_large_other']] <- 
   repFilter(rep_data,
            .method = 'by.meta',
            list(chain = exclude('TRA', 'TRB'),
                 size = include('L'))) %>%
  repExplore(.data = .[['data']], .method = c("volume")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Volume)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=3) +
  labs(x='Chain', y='Unique clones')
figures[['unique_clones_large_other']]
```

## Small

### TRATRB

```{r}
figures[['unique_clones_small_TRATRB']] <- 
   repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('S'))) %>%
  repExplore(.data = .[['data']], .method = c("volume")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Volume)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=2) +
  labs(x='Chain', y='Unique clones')
figures[['unique_clones_small_TRATRB']]
```

### other

```{r}
figures[['unique_clones_large_other']] <- 
   repFilter(rep_data,
            .method = 'by.meta',
            list(chain = exclude('TRA', 'TRB'),
                 size = include('S'))) %>%
  repExplore(.data = .[['data']], .method = c("volume")) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Volume)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=3) +
  labs(x='Chain', y='Unique clones')
figures[['unique_clones_large_other']]
```

# Clone count proportions

## Large

### TRATRB

```{r}
figures[['clone_count_proportion_large_TRATRB']] <-
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('L'))) %>%
  repClonality(.data = .[['data']], .method='rare') %>%
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  reshape2::melt(id.col='Sample') %>%
  group_by(Sample) %>%
  mutate(x = value-lag(value, default = 0)) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=paste0(individual, replicate), y=x, fill=variable)) +
  geom_col(position='stack') +
  # theme_bw() +
  theme(axis.text.x = element_text(angle=90)) +
  scale_fill_manual(values=color('muted')(6), labels=c('1','2-3','4-10','11-30','31-100', '101-MAX')) +
  labs(x='sample', y='Portion of repertoire', fill='Clonotype counts') +
  facet_nested(~kit + chain, scales = 'free_x') 
figures[['clone_count_proportion_large_TRATRB']]
```

## Small

### TRATRB

```{r}
figures[['clone_count_proportion_small_TRATRB']] <-
  repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('S'))) %>%
  repClonality(.data = .[['data']], .method='rare') %>%
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  reshape2::melt(id.col='Sample') %>%
  group_by(Sample) %>%
  mutate(x = value-lag(value, default = 0)) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=paste0(individual, replicate), y=x, fill=variable)) +
  geom_col(position='stack') +
  # theme_bw() +
  theme(axis.text.x = element_text(angle=90)) +
  scale_fill_manual(values=color('muted')(6), labels=c('1','2-3','4-10','11-30','31-100', '101-MAX')) +
  labs(x='sample', y='Portion of repertoire', fill='Clonotype counts') +
  facet_nested(~kit + chain, scales = 'free_x') 
figures[['clone_count_proportion_small_TRATRB']]
```

# Clone frequency proportion

## Large

```{r}
figures[['clone_frequency_proportion_large_TRATRB']] <-
  repFilter(rep_data,
              .method = 'by.meta',
              list(chain = include('TRA', 'TRB'),
                   size = include('L'))) %>%
  repClonality(.data = .[['data']], .method='homeo') %>%
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  reshape2::melt(id.col='Sample') %>%
  group_by(Sample) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=paste0(individual, replicate), y=value, fill=variable)) +
  geom_col(position='stack') +
  # theme_bw() +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x='Sample', y='Portion of repertoire', fill='Clonotype group', title = 'Clonal space homeostasis', caption= 'Summary of proportion of clonotypes with specific frequencies') +
  facet_nested(~kit + chain, scales = 'free_x') 
figures[['clone_frequency_proportion_large_TRATRB']]
```

## Small

```{r}
figures[['clone_frequency_proportion_small_TRATRB']] <-
  repFilter(rep_data,
              .method = 'by.meta',
              list(chain = include('TRA', 'TRB'),
                   size = include('S'))) %>%
  repClonality(.data = .[['data']], .method='homeo') %>%
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  reshape2::melt(id.col='Sample') %>%
  group_by(Sample) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=paste0(individual, replicate), y=value, fill=variable)) +
  geom_col(position='stack') +
  # theme_bw() +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x='Sample', y='Portion of repertoire', fill='Clonotype group', title = 'Clonal space homeostasis', caption= 'Summary of proportion of clonotypes with specific frequencies') +
  facet_nested(~kit + chain, scales = 'free_x') 
figures[['clone_frequency_proportion_small_TRATRB']]
```

# Diversity estimation

## Large

```{r}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('L'))) 
plotdata <- repDiversity(.data=plotdata$data, .method = 'inv.simp') %>%
  left_join(rep_data$meta, by = 'Sample')
figures[['simpson_large']] <-
  ggplot(plotdata, aes(x=kit, y=Value)) +
    geom_boxplot(outliers = FALSE) +
    geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=2) +
  scale_y_log10() +
  labs(x='Chain', y='Simpson index', caption='Y axis is log scaled')
  
figures[['simpson_large']]
```

## Small

```{r}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('S'))) 
figures[['simpson_small']] <-
  repDiversity(.data=plotdata$data, .method = 'inv.simp') %>%
  left_join(rep_data$meta, by = 'Sample') %>%
  ggplot(aes(x=kit, y=Value)) +
    geom_boxplot(outliers = FALSE) +
    geom_beeswarm(aes(shape=individual), size=2) +
  theme_bw() +
  theme(panel.spacing = unit(0, "lines")) +
  facet_wrap(~chain, strip.position = 'top', ncol=2) +
  labs(x='Chain', y='Simpson index')
  
figures[['simpson_small']]
```

# Clonal overlap

## All

### TRA

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'overlap') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['overlap_all_tra']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)_TRA', '\\1', Var1),
         Var2 = gsub('(.+)_TRA', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(10.5,22.5), color='red') + 
  geom_hline(yintercept = c(10.5,22.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Overlap') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['overlap_all_tra']] 
```

### TRB

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'overlap') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['overlap_all_trb']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)_TRB', '\\1', Var1),
         Var2 = gsub('(.+)_TRB', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(10.5,22.5), color='red') + 
  geom_hline(yintercept = c(10.5,22.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Overlap') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['overlap_all_trb']] 
```

## Small

### TRA

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 size = include('S'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'overlap') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['overlap_small_tra']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)_TRA', '\\1', Var1),
         Var2 = gsub('(.+)_TRA', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(4.5,10.5), color='red') + 
  geom_hline(yintercept = c(4.5,10.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Overlap') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['overlap_small_tra']] 
```

### TRB

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'),
                 size = include('S'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'overlap') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['overlap_small_trb']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)_TRB', '\\1', Var1),
         Var2 = gsub('(.+)_TRB', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(4.5,10.5), color='red') + 
  geom_hline(yintercept = c(4.5,10.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Overlap') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['overlap_small_trb']] 
```

## Large

### TRA

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA'),
                 size = include('L'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'overlap') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['overlap_large_tra']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)_TRA', '\\1', Var1),
         Var2 = gsub('(.+)_TRA', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,12.5), color='red') + 
  geom_hline(yintercept = c(6.5,12.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Overlap') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['overlap_large_tra']] 
```

### TRB

```{r, fig.width=8, fig.height=8}
plotdata <- repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRB'),
                 size = include('L'))) 
plotdata <- repOverlap(.data = plotdata$data, .method = 'overlap') 
plotdata <- round(plotdata, 2) %>%
  reshape2::melt()

figures[['overlap_large_trb']] <- 
  (plotdata %>%
  mutate(Var1 = gsub('(.+)_TRB', '\\1', Var1),
         Var2 = gsub('(.+)_TRB', '\\1', Var2)) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() +
  geom_vline(xintercept = c(6.5,12.5), color='red') + 
  geom_hline(yintercept = c(6.5,12.5), color='red') + 
  theme_bw() +
  labs(x='Sample 1', y='Sample 2', fill = 'Overlap') +
  viridis::scale_fill_viridis() + 
  theme(axis.text.x = element_text(angle=90))) %>%
  ggplotly()
figures[['overlap_large_trb']] 
```

# Saturation curves

## Large

```{r}
downsampled_obj_large <- list()
for (j in names(repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('L')))$data)) {
  for (i in 10^seq(5,7,length.out=10)) {
    k <- sum(rep_data$data[[j]]$Clones)
    if (i < k) {
      downsampled_obj_large[[paste0(j, '@', as.character(i))]] <- repSample(rep_data$data[[j]],
                                                                            .method='downsample',
                                                                            .n = i)
    } 
  } 
  downsampled_obj_large[[paste0(j, '@', as.character(k))]] <- rep_data$data[[j]]
}
```

```{r}
plotdata <- repExplore(downsampled_obj_large, .method = c("volume")) %>%
  separate(Sample, c('Sample', 'libsize'), sep='@') %>%
  mutate(libsize= as.numeric(libsize)) %>%
  left_join(rep_data$meta, by = 'Sample')
figures[['clone_saturation_curves_large']] <- 
  ggplot(plotdata, aes(x=libsize, y=Volume, color=individual, group=Sample)) +
  geom_path() +
  geom_point(size=0.25) +
  theme_bw() +
  facet_nested(rows=vars(kit), cols = vars(chain)) +
  scale_x_log10() +
  theme(panel.spacing = unit(0, "lines")) +
  labs(x='UMI count', y='Unique clones', caption = 'The final point for each curve is the full library size') 
figures[['clone_saturation_curves_large']]
```


## Small

```{r}
downsampled_obj_small <- list()
for (j in names(repFilter(rep_data,
            .method = 'by.meta',
            list(chain = include('TRA', 'TRB'),
                 size = include('S')))$data)) {
  for (i in 10^seq(4,6,length.out=10)) {
    k <- sum(rep_data$data[[j]]$Clones)
    if (i < k) {
      downsampled_obj_small[[paste0(j, '@', as.character(i))]] <- repSample(rep_data$data[[j]],
                                                                            .method='downsample',
                                                                            .n = i)
    } 
  } 
  downsampled_obj_small[[paste0(j, '@', as.character(k))]] <- rep_data$data[[j]]
}
```

```{r}
figures[['clone_saturation_curves_small']] <-
  repExplore(downsampled_obj_small, .method = c("volume")) %>%
  separate(Sample, c('Sample', 'libsize'), sep='@') %>%
  mutate(libsize= as.numeric(libsize)) %>%
  left_join(rep_data$meta, by = 'Sample') %>%
ggplot(aes(x=libsize, y=Volume, color=individual, group=Sample)) +
  geom_path() + 
  geom_point(size=0.25) +
  theme_bw() +
  facet_nested(rows=vars(kit), cols = vars(chain)) +
  scale_x_log10() +
  theme(panel.spacing = unit(0, "lines")) +
  labs(x='UMI count', y='Unique clones', caption = 'The final point for each curve is the full library size') 
figures[['clone_saturation_curves_small']]
```


# Render report

```{r}
## This only works if all the variables called in the format file 
## are in the current environment. Check the format file to tweak aesthetics 
rmarkdown::render(here('scripts/01-pipeline_QC.format.Rmd'),
                  output_file = '01_QC.html',
                  output_dir = here('reports'))
```